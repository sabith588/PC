name: RDP-PC-with-Tailscale

on:
  workflow_dispatch:   # manual trigger

jobs:
  setup-rdp:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.ps1 | powershell -NoProfile -ExecutionPolicy Bypass -

      - name: Authenticate Tailscale
        run: |
          tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-rdp --accept-routes --ssh

      - name: Enable RDP
        run: |
          powershell -Command "
            Set-ItemProperty -Path 'HKLM:\\System\\CurrentControlSet\\Control\\Terminal Server' -Name 'fDenyTSConnections' -Value 0;
            Enable-NetFirewallRule -DisplayGroup 'Remote Desktop';
          "

      - name: Show Tailscale IP
        run: |
          tailscale ip -4
